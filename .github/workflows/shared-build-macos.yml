##########################
#
# Apple macOS
# macOS 15
#
# This version is used as the OS, as it's faster than other versions.
##########################
name: "macOS Builds"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: RelWithDebInfo
  RELEASE_STAGE: ${{ vars.RELEASE_STAGE || 'unstable' }}

jobs:
  build:
    name: "Building for platform macos-arm64"
    runs-on: "macos-15"
    env:
        openal-soft-branch: '1.24.3'
        curl-version: '8_12_1'
        sdl2-branch: 'release-2.32.8'

    steps:
    ###
    # Packages
    ###

    - name: Install required packages
      run: |
        brew install flex bison llvm
    # Those packages are already installed  
    #brew install git ninja cmake perl

    - name: Settings
      working-directory: ${{github.workspace}}
      run: |
        echo "CMAKE_GENERATOR=Ninja Multi-Config" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV
        echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV

    ###
    # SDL
    ###

    # Cache SDL
    - name: Cache SDL2
      id: cache-sdl2
      uses: actions/cache@v4
      with:
        path: 'thirdparties/SDL2/install'
        key: ${{ runner.os }}-arm64-sdl2-${{ env.sdl2-branch }}-v1

    # SDL2 setup
    - name: Checkout SDL2
      if: steps.cache-sdl2.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: 'libsdl-org/SDL'
        path: 'thirdparties/SDL2'
        ref: '${{ env.sdl2-branch }}'

    - name: Configure and install SDL2
      if: steps.cache-sdl2.outputs.cache-hit != 'true'
      working-directory: ${{github.workspace}}/thirdparties/SDL2
      run: |
        cmake -B ./build \
        -DCMAKE_INSTALL_PREFIX='${{github.workspace}}/thirdparties/SDL2/install' \
        -DCMAKE_OSX_ARCHITECTURES='arm64'
        cmake --build ./build --config Release --parallel
        cmake --install ./build --config Release

    ###
    # OpenAL
    ###
    - name: Cache OpenAL
      id: cache-openal-soft
      uses: actions/cache@v4
      with:
        path: 'thirdparties/soft-oal/install'
        key: ${{ runner.os }}-arm64-openal-soft-${{ env.openal-soft-branch }}-v1

    # soft-oal setup
    - name: Checkout soft-oal
      if: steps.cache-openal-soft.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: 'kcat/openal-soft'
        path: 'thirdparties/soft-oal'
        ref: '${{ env.openal-soft-branch }}'

    # soft-oal build
    - name: Configure and install soft-oal
      if: steps.cache-openal-soft.outputs.cache-hit != 'true'
      working-directory: ${{github.workspace}}/thirdparties/soft-oal
      run: |
        cmake -B ./build \
        -DCMAKE_INSTALL_PREFIX='${{github.workspace}}/thirdparties/soft-oal/install' \
        -DCMAKE_OSX_ARCHITECTURES='arm64' \
        -DCMAKE_VERBOSE_MAKEFILE=on
        cmake --build ./build --config Release --parallel
        cmake --install ./build --config Release

    ###
    # cURL
    ###
    - name: Cache cURL
      id: cache-curl
      uses: actions/cache@v4
      with:
        path: 'thirdparties/curl/install'
        key: ${{ runner.os }}-arm64-curl-${{ env.curl-version }}-v1

    # cURL setup
    - name: Checkout cURL
      if: steps.cache-curl.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: 'curl/curl'
        path: 'thirdparties/curl'
        ref: 'curl-${{ env.curl-version }}'

    # cURL build
    - name: Configure and install curl
      if: steps.cache-curl.outputs.cache-hit != 'true'
      working-directory: ${{github.workspace}}/thirdparties/curl
      run: |
        cmake -B ./build \
            -DCMAKE_INSTALL_PREFIX='${{github.workspace}}/thirdparties/curl/install' \
            -DCMAKE_OSX_ARCHITECTURES='arm64' \
            -DCURL_USE_LIBPSL=OFF \
            -DCURL_USE_WOLFSSL=OFF \
            -DCURL_USE_LIBSSH2=OFF \
            -DUSE_LIBIDN2=OFF \
            -DUSE_NGHTTP2=OFF \
            -DCURL_ENABLE_SSL=OFF \
            -DCURL_ZLIB="" \
            -DCURL_BROTLI="" \
            -DCURL_ZSTD="" \
            -DWolfSSL_ROOT='${{github.workspace}}/thirdparties/wolfssl_install'
        cmake --build ./build --config Release --parallel
        cmake --install ./build --config Release

    ###
    # Project
    ###

    - uses: actions/checkout@v4
      with:
        path: 'source'

    - name: CMake Settings
      run: |
        echo "CMAKE_PARAM=--log-level=VERBOSE \
        -DCMAKE_INSTALL_PREFIX='${{github.workspace}}/install' \
        -DCMAKE_VERBOSE_MAKEFILE=on \
        -DCMAKE_OSX_ARCHITECTURES='arm64' \
        -DUSE_INTERNAL_SDL=OFF \
        -DSDL2_DIR='${{github.workspace}}/thirdparties/SDL2/install/lib/cmake/SDL2' \
        -DOPENAL_LIBRARY='${{github.workspace}}/thirdparties/soft-oal/install' \
        -DOPENAL_INCLUDE_DIR='${{github.workspace}}/thirdparties/soft-oal/install/include/AL' \
        -DCURL_ROOT='${{github.workspace}}/thirdparties/curl/install' \
        -DUSE_RENDERER_DLOPEN=OFF \
        -DBUILD_RENDERER_GL2=OFF \
        -DGIT_REVISION_BUILD_NUMBER=${{ github.run_number }} \
        -DPRODUCT_VERSION_STAGE='${{ env.RELEASE_STAGE }}'" >> $GITHUB_ENV

    - name: Configure CMake
      working-directory: ${{github.workspace}}
      run: |
        cmake -B ./build ${{ env.CMAKE_PARAM }} ./source

    - name: Build
      working-directory: ${{github.workspace}}
      run: |
        cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel

    - name: Install
      working-directory: ${{github.workspace}}
      # Install to the directory defined in CMAKE_INSTALL_PREFIX
      run: |
        cmake --install ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
        mkdir ${{github.workspace}}/package
        if [ -d ${{github.workspace}}/install/bin ]; then cp -r ${{github.workspace}}/install/bin/openmohaa/. '${{github.workspace}}/package'; fi
        if [ -d ${{github.workspace}}/install/lib ]; then cp -r ${{github.workspace}}/install/lib/openmohaa/. '${{github.workspace}}/package'; fi
        # Copy dylibs into the .app bundle (rpath is @executable_path)
        cp -l ${{github.workspace}}/thirdparties/SDL2/install/lib/libSDL2-2.0.0.dylib '${{github.workspace}}/package/openmohaa.app/Contents/MacOS/'
        cp -l ${{github.workspace}}/thirdparties/soft-oal/install/lib/libopenal.1.dylib '${{github.workspace}}/package/openmohaa.app/Contents/MacOS/'
        cp -l ${{github.workspace}}/thirdparties/curl/install/lib*/libcurl.4.dylib '${{github.workspace}}/package/openmohaa.app/Contents/MacOS/'
        # Also keep dylibs at package root for the dedicated server
        cp -l ${{github.workspace}}/thirdparties/SDL2/install/lib/libSDL2-2.0.0.dylib '${{github.workspace}}/package/'
        cp -l ${{github.workspace}}/thirdparties/soft-oal/install/lib/libopenal.1.dylib '${{github.workspace}}/package/'
        cp -l ${{github.workspace}}/thirdparties/curl/install/lib*/libcurl.4.dylib '${{github.workspace}}/package/'

    ###
    # Artifacts
    ###

    - uses: actions/upload-artifact@v4
      with:
        name: out-macos-arm64
        if-no-files-found: error
        compression-level: 9
        path:
          ${{github.workspace}}/package
